---
layout: inner
title: How to Use Pipes
lead_text: ''
permalink: /how-to-use/
---

# How Do I Use It?

<a name="data-model"></a>
## Define the entities model in DHF

Pipes creates custom step code for your MarkLogic DataHub flows.

Let's create a custom code which will read in sample customer records and produce instances of Customer and Address entities, based on this data.

As a basis, we'll use a sample DHF project defined in [Examples/Customer360](https://github.com/marklogic-community/pipes/tree/master/Examples/Customer360).

If we deploy this project on a MarkLogic server and run DHF QS UI, we'll see the definition of Customer and Address entities, like below:

![](../images/how-to-use/dhf-entities.png)

The Customer360 project already comes with pre-defined flow and steps so you can skip ahed to [Ingest Data](#Ingest-Data)

## Create the flow

Now that we have the data model defined, let's create a flow to ingest data and transform it using a custom step created with Pipes.

In the DHF QuickStart, click on the Flows tab and then on the "NEW FLOW" button. Create a flow called Customer360. You should see this:

![](../images/how-to-use/dhf-flow-empty.png)

## Add ingest and custom steps

Now click on the flow name (Customer360) to go into the flow definition. It will be empty and look like this:

![](../images/how-to-use/dhf-flow-inside-empty.png)

Now, let's add an Ingest step. Click on "NEW STEP" and define the step as shown in the picture below:

![](../images/how-to-use/dhf-flow-new-ingest-step.png)

When you clean on "SAVE", you should see this:

![](../images/how-to-use/dhf-flow-ingest-step.png)

Configure the Source Directory Path to the folder that contains the MOCK_DATA.csv file. Set "Delimited Text" as Source Format, Field Separator is "," and Target Format should be "JSON".

<a name="custom-step"></a>
Let's add a custom step now. As before, click on "NEW STEP" and define a Custom (type: Other) step.

Let's name it "customer-address-custom", and select "Customer-Source" as the Source Collection. Select "Customer" or "Address" as the Target Entity:

![](../images/how-to-use/dhf-flow-creating-custom-step.png)

Click on save and you will see:

![](../images/how-to-use/dhf-flow-full.png)

## Ingest data

Click on the "RUN", deselect the "customer-address-custom" checkbox and click the "RUN" button.

![](../images/how-to-use/dhf-flow-run-ingest.png)

Once the ingest finishes, click on the "Browse Data" tab to check that the data has been ingested as expected. You should see 1000 documents in the "customer-source" collection:

![](../images/how-to-use/dhf-browse-staging-data.png)

Congratulations, you've ingested data into MarkLogic. Now, let's transform it with Pipes.

## Build a graph in Pipes for the custom step using ingested data

<a name="minimal-graph"></a>
### Log in

Assuming that Pipes is running on localhost and port 9085, open http://localhost:9085 in your browser and log into Pipes:

![](../images/how-to-use/pipes-1-login.png)

Enter the username and password of one of the DHF users (such as flow-developer or flow-operator) and, after logging in, you should see:

![](../images/how-to-use/pipes-2-new-graph.png)

The biggest part of the UI is taken by the canvas. On the canvas we can see 2 blocks. **Any Pipes graph we build must contain these blocks**.

### **Custom Step Input** block:

![](../images/how-to-use/pipes-3-input.png)

This block represents the input to the custom step we're designing here. As the input into the custom step, we specified collection "Customer-Source" as we were defining the custom step in the DHF QuickStart. The _Custom Step Input_ block has 3 nodes on the right side. That means it provides 3 different things:

- **input**: Provides the content of the document(s) in the "Customer-Source" collection. That's the content we will be transforming in the graph into our data model entities.

- **uri**: provides the URI of the incoming document. This can be useful for storing provenance information, for instance.

- **collections**: provides the collections of the incoming document as an array. This, too, is a useful provenance information that can be passed down into the final data model.

### **Custom Step Output** block

![](../images/how-to-use/pipes-4-output.png)

This block represents the content that will be generated by the custom step. Everything we feed into it's output node will be outputed by the custom step.

### The minimal graph and running the graph preview

Let's connect these 2 blocks: click and hold the left mouse button on the **input** node of the _Custom Step Input_ block, move it to the **output** node of the _Custom Step Output_ block and release the mouse button there.

![](../images/how-to-use/min-graph-connect.gif)


<a name="run-preview"></a>
Great job.
As we build our graph, we can always preview its output. We do that by doing following:

- In the top bar menu, click on the "Play" button
- The "Preview Graph Execution" wizard will open
- The wizard requires to know which database and collection to use as a source. Since we've already defined our Custom Step in the QuickStart UI, we can select the "Custom DHF Step" option and click on "Continue"
- In the drop-down, we'll select the our custom step "customer-address-custom" (we defined it earlier ðŸ‘†)
- We'll also check the "Random document" checkbox. This will allow us to execute the preview multiple times, each time using another document as the source
- Click "Continue"
- On the "Save result to Database?" question, we'll leave the checkbox unchecked and click "Continue"

Now, we'll see a summary of our selection:
![](../images/how-to-use/preview-summary.png)

The source database and collection have been determined based on the information in the custom step.

Click on "Execute Preview" and scroll down to check the results. Notice that the graph produced the input document at its output. This is because we didn't define any transformation yet but simply connected the input with the output. 

Click again on "Execute Preview", scroll down to check the result and notice that another source document was used. This is the result of the "Random Document" checkbox. If we uncheck that, we'll be getting the same source document each time we click on "Execute Preview". This can be useful when we're developing the graph and want to understand how the output has changed since the last time we ran the preview.

Here's the summary of our actions in an animated GIF:

![](../images/how-to-use/preview-minimal.gif)

### Add envelope

- Hover over an empty place on the canvas and right-click
- Now, left-click on the "Add Node"
- Left-click on the "DHF" group and another sub-group will open
- Left-click on "Evelope.
- The Envelope block will appear on the canvas

![](../images/how-to-use/adding-envelope.gif)

When creating data hub with MarkLogic using the Data Hub Framework, we  use the envelope data pattern to group data and meta-data together. The Enevelope block in Pipes enforces this pattern.

![](../images/how-to-use/envelope.png)

As we build our graph, we will be directing our data into the Envelope nodes.

Let's connect the Evenlope into the graph.

- Click the **output** node of the _Custom Step Output_ block to lose the connection
- Connect the **output** node of the _Envelope_ to the **output** node of the _Custom Step Output_
- Connect the **input** node of the _Custom Step Input_ to the **instance** node of the _Envelope_

That's it, we're now producing an envelope at the output of our custom step. Run the preview to see how the output has changed.

![](../images/how-to-use/connect-envelope.gif)

<a name="entity-blocks"></a>
### Create Entity blocks

The data model is defined by the entities and their relationships we created in the QuickStart UI. Let's create blocks that represent the DHF Entities in Pipes.

- In the upper-left corner, click on the "Setting and Block Creation button"
- Click on the "ENTITY BLOCKS" tab
- In the drop-down, select "Customer"
- The properties of the Customer Entity, as defined in QuickStart UI, will be shown
- Click on "CREATE ENTITY BLOCK"
- Do the same for the Address entity by selecting it in the drop-down and clicking on the "CREATE ENTITY BLOCK" button

![](../images/how-to-use/create-entity-blocks.gif)

Let's add Entity blocks to our graph.

- Hover over an empty place on the canvas and right-click
- Now, left-click on the "Add Node"
- Letf-click on "Entities" (all the way at the bottom)
- Select _Customer_
- Connect the _Customer_ **Node** with the _Envelope_ **Instance**

![](../images/how-to-use/adding-entity-block.gif)

<a name="source-blocks"></a>
### Create source blocks

Now, we need to map some source into our Entity block. We'll do that by creating a Source block that captures part of the data we will use to map the _Customer_ block.

- In the upper-left corner, click on the "Setting and Block Creation button"
- Click on the "SOURCE BLOCKS" tab
- Click on the "START NEW BLOCK" button
- Enter a name for the block: "customer-source"
- (Optionally, add a description)
- Click "NEXT"
- From the drop-down, select the name of the custom step we created earlier: "customer-address-custom"
- Click "NEXT"
- Click on the gray triangle next to "Document Fields"
- Repeat the same for "envelope" and "instance"
- Notice that you've partially expanded the document tree now
- Check the boxes next to values we want to capture from the source: "dob", "email", "first_name", "gender", "id" and "last_name"
- Click "NEXT"
- You'll see a block preview, on the left there should be **Node** and on the right there should be the field names we've selected in the previous step
- Finally, click the "CREATE SOURCE BLOCK"

Here's the summary of our actions in an animated GIF:

![](../images/how-to-use/create-source-block.gif)

<a name="map-values"></a>
### Map values

Let's add the source block we've just created to the graph and connect it.

- Hover over an empty place on the canvas and right-click
- Now, left-click on the "Add Node"
- Click on "Sources" (at the bottom)
- Click on "customer-source", the block that we just defined
- Connect the nodes between _customer-source_ and _Customer_ in the following way
- - dob -> dateOfBirth
- - email -> email
- - id -> externalId
- - first_name -> firstName
- - gender -> gender
- - last_name -> last_name
- Finally, connect the _Custom Step Input_ **input** to _customer-source_ **node**

Here's the summary of our actions in an animated GIF:

![](../images/how-to-use/adding-source-block.gif)

Let's run the preview and see what our graph will output.

![](../images/how-to-use/source-entity-blocks-preview.gif)

### Add the address entity and map values

- Add the Address Entity block to the canvas
- Create the "address-source" source block, similar to how you created the "customer-source" source block
- Add the _address-source_ to the canvas
- Map the values between _address-source_ and _Address_ block. The **customerId** should be mapped from _customer_source_ **id** node.
- Connect _Custom Step Input_ **Input** with _address-source_ **Node**
- On the _Address_ block uncheck/disable the WithInstanceRoot toggle
- Connect _Address_ **Node** to _Customer_ **address**

Here's the summary of our actions in an animated GIF:

![](../images/how-to-use/adding-address.gif)

Now, let's run the preview and have a look at the result.

![](../images/how-to-use/customer-address-preview.gif)

<a name="custom-uris"></a>
### Create custom URIs

The Envelope block contains an URI node. However, if that node remains unmapped, the resulting document will have the same URI as the source document. In many situations, we'd like to be able to change the URI.

- Add a "Unique ID" block to the canvas (Generate->Unique ID), below the _Customer_ block
- Click on the field with the prefix and clear the content
- Add a "String Template" block to the canvas (Generate->String Template)
- Connect _Unique ID_ **uuid** with _String Template_ **v1**
- On the _String Template_, click on the template field and define the template as "/customer/${v1}.json"
- Connect _String Template_ **newString** to the _Envelope_ **uri**
- Connect Connect _Unique ID_ **uuid** to the _Customer_ **id** to re-use the same uuid for the Customer id
- Run the preview to see how the URI of the resulting document changed but also the "id" property in the Customer instance

Now, let's run the preview and have a look at the result. Observe the new URI and the Customer's id.

![](../images/how-to-use/customer-address-uri.gif)

<a name="1-to-many"></a>
### Create multiple Entity instances (1 to many mapping)

Sometimes, we want to create a more normalized model of the data. For instance, the address is a business domain entity that can be independent from the customer's personal details and have a separate life cycle.

Let's see how we use Pipes to create multiple Entity instances.

- Add another Envelope block to the canvas
- Enable the WithInstanceRoot toggle on the _Address_
- Connect _Address_ **Node** to new _Envelope's_ **instance**
- Add a "Generate Array" block to the canvas (Join->Generate Array)
- Connect *both* Envelopes to this block: Customer Envelope to **item1** and Address Envelope to **item2**
- Connect _Generate Array_ **array** to _Custom Step Output_ **output**
- Create a unique URI for the Address Envelope
- Optionally, map the _Custom Step Input_ **uri** to both Envelope's **uri**, this will add provenance information (the originating uri) to the resulting documents
- Run the preview and observe that the graph is now producing an array of 2 json documents - a document per Entity from our data model

![](../images/how-to-use/multiple-instances.gif)

## Save the custom step code from Pipes into the DHF project

## Run the custom step


